<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buzzer</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #videoStream { width: 640px; height: 480px; border: 1px solid black; }
        .controls button { margin: 10px; padding: 15px 30px; font-size: 1.2em; }
        .buzzer-controls button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        .buzzer-controls button.off { background-color: #f44336; }
    </style>
</head>
<body>
    <h1>Buzzer Test</h1>

    <div class="video-container">
        <h2>Live Video Feed</h2>
        <img id="videoStream" src="https://raspberrypi-camera-server.at.remote.it:5000" alt="Live Video Stream">
    </div>

    <div class="controls">
        <h2>Buzzer Controls</h2>
        <div class="buzzer-controls">
            <button onclick="publishBuzzerCommand('on')">Buzzer ON</button>
            <button class="off" onclick="publishBuzzerCommand('off')">Buzzer OFF</button>
        </div>
    </div>

    <p id="status">Connecting to MQTT...</p>

    <script>
       
        const MQTT_BROKER_HOST = "https://raspberrypi-rover-mqtt.at.remote.it"; 
        const MQTT_BROKER_PORT = 33000; 
        const MQTT_BUZZER_TOPIC = "rover/buzzer"; // Topic for buzzer commands

        let client;

        function connectMqtt() {
            client = mqtt.connect({
                host: MQTT_BROKER_HOST,
                port: MQTT_BROKER_PORT,
                protocol: 'ws', // Use websockets when connecting from a browser
                // For anonymous access, no username/password needed
            });

            client.on('connect', function () {
                console.log('Connected to MQTT broker');
                document.getElementById('status').innerText = 'Connected to MQTT broker.';
            });

            client.on('error', function (error) {
                console.error('MQTT error:', error);
                document.getElementById('status').innerText = 'MQTT Error: ' + error.message;
            });

            client.on('close', function () {
                console.log('MQTT connection closed. Attempting to reconnect...');
                document.getElementById('status').innerText = 'MQTT Disconnected. Reconnecting...';
                setTimeout(connectMqtt, 5000); // Attempt to reconnect after 5 seconds
            });
        }

        function publishBuzzerCommand(command) {
            if (client && client.connected) {
                client.publish(MQTT_BUZZER_TOPIC, command);
                console.log(`Published buzzer command: ${command}`);
            } else {
                console.warn('MQTT client not connected. Cannot publish command.');
                document.getElementById('status').innerText = 'MQTT Not Connected! Check console for errors.';
            }
        }

        // Initialize MQTT connection when the page loads
        document.addEventListener('DOMContentLoaded', connectMqtt);
    </script>
</body>
</html>
